<div id="map"></div>

<script>
var map;
var marker = null;
var infowindow = new google.maps.InfoWindow(
{
size: new google.maps.Size(150,50)
}); 

$(document).ready(function () {

var lat = $('#location_latitude').val();
var long = $('#location_longitude').val();

if (!!lat && !!long)  {
var loc = new google.maps.LatLng(lat, long);
var myOptions = {
zoom: 15,
center: loc,
mapTypeId: google.maps.MapTypeId.ROADMAP
}
createMap( myOptions, infowindow);

} else {
// test for presence of geolocation
if (navigator && navigator.geolocation) {
navigator.geolocation.getCurrentPosition(geo_success, geo_error );
} else {
alert('Geolocation not supported.');
}
}
});

function geo_success(position) {
getLoc(position.coords.latitude, position.coords.longitude);
}

function geo_error(err) {
if (err.code == 1) {
alert('Location information denied by user.');
} else if (err.code == 2) {
alert('Location information is unavailable.');
} else if (err.code == 3) {
alert('Location information timed out.');
} else {
alert('An unknown error occurred.');
}
}

// output lat and long
function getLoc(lat, long) {
var loc = new google.maps.LatLng(lat, long);
//$('#directions').append('<p>Lat: ' + lat + '</p>');
//$('#directions').append('<p>Long: ' + long + '</p>');
var myOptions = {
zoom: 15,
center: loc,
mapTypeId: google.maps.MapTypeId.ROADMAP
}
createMap( myOptions);

}

function createMap( myOptions)
{

map = new google.maps.Map(document.getElementById("map"), myOptions);

google.maps.event.addListener(map, 'click', function() {
	infowindow.close();
});
google.maps.event.addListener(map, 'click', function(event) {
	//call function to create marker
	if (marker) {
	marker.setMap(null);
	marker = null;
	}
	marker = createMarker(event.latLng, "name", "<b>Location</b><br>"+event.latLng ,map);

	$('#location_latitude').val(myOptions.center.lat()).change();
        $('#location_longitude').val(myOptions.center.lng()).change();

}); 

createMarker(myOptions.center, "name", "<b>Location</b><br>"+myOptions.center, map)

}


// A function to create the marker and set up the event window function
function createMarker(latlng, name, html, map) {
	var contentString = html;
	var marker = new google.maps.Marker({
	position: latlng,
	map: map,
	zIndex: Math.round(latlng.lat()*-100000)<<5
	});
	google.maps.event.addListener(marker, 'click', function() {
	infowindow.setContent(contentString);
	infowindow.open(map,marker);
	});
	google.maps.event.trigger(marker, 'click');
	return marker;
} 

</script>
